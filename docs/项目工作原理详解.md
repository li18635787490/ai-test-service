# AI 文档检测与报告服务 - 工作原理详解

## 📐 整体架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                        前端 Web UI (静态页面)                          │
│                    app/static/index.html + app.js                   │
└───────────────────────────────┬─────────────────────────────────────┘
                                │ HTTP API
┌───────────────────────────────▼─────────────────────────────────────┐
│                        FastAPI 应用 (main.py)                        │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────────────┐   │
│  │ documents│ │  check   │ │ reports  │ │    requirements      │   │
│  │  Router  │ │  Router  │ │  Router  │ │       Router         │   │
│  └────┬─────┘ └────┬─────┘ └────┬─────┘ └──────────┬───────────┘   │
└───────┼────────────┼────────────┼──────────────────┼────────────────┘
        │            │            │                  │
┌───────▼────────────▼────────────▼──────────────────▼────────────────┐
│                          服务层 (Services)                           │
│  ┌────────────────┐  ┌────────────────┐  ┌──────────────────────┐   │
│  │ document_parser│  │ check_service  │  │ requirement_analyzer │   │
│  │   (文档解析)    │  │  (检测核心)     │  │   (需求分析)          │   │
│  └───────┬────────┘  └───────┬────────┘  └───────────┬──────────┘   │
│          │                   │                       │              │
│  ┌───────▼───────────────────▼───────────────────────▼──────────┐   │
│  │                   ai_providers (AI 统一接口)                   │   │
│  │     支持: OpenAI GPT-4 | Anthropic Claude | 通义千问           │   │
│  └──────────────────────────┬───────────────────────────────────┘   │
└─────────────────────────────┼───────────────────────────────────────┘
                              │ API 调用
                    ┌─────────▼─────────┐
                    │   外部 AI 服务     │
                    │ OpenAI/Claude/千问 │
                    └───────────────────┘
```

---

## 🔄 核心工作流程

### 1️⃣ 文档上传流程

```
用户上传文件 → 验证格式 → 生成唯一ID → 保存到 uploads/ → 解析文档获取页数 → 返回文档信息
```

**关键代码**: `app/routers/documents.py`
- 支持格式: PDF, DOCX, XLSX, PPTX, TXT, MD
- 生成 UUID 作为文档唯一标识
- 文件存储在 `uploads/` 目录

---

### 2️⃣ 文档检测流程（核心功能）

```
┌────────────┐    ┌────────────┐    ┌────────────┐    ┌────────────┐
│ 接收请求    │ →  │ 解析文档    │ →  │ 创建异步任务 │ →  │ 返回任务ID  │
│ document_id│    │ 提取文本    │    │ 后台处理    │    │ 前端轮询   │
└────────────┘    └────────────┘    └────────────┘    └────────────┘
                                           │
                                           ▼
                  ┌─────────────────────────────────────────────┐
                  │              异步检测任务                    │
                  │  ┌─────────┐                                │
                  │  │ 维度1   │→ AI分析 → 评分 + 问题列表        │
                  │  ├─────────┤                                │
                  │  │ 维度2   │→ AI分析 → 评分 + 问题列表        │
                  │  ├─────────┤                                │
                  │  │ 维度N   │→ AI分析 → 评分 + 问题列表        │
                  │  └─────────┘                                │
                  │       ↓                                     │
                  │  生成整体总结 → 计算综合得分 → 更新任务状态      │
                  └─────────────────────────────────────────────┘
```

**检测维度**（`app/models.py`中定义）:

| 维度 | 标识 | AI 分析内容 |
|-----|------|------------|
| 格式规范 | `format` | 标题层级、段落结构、标点符号、列表/表格格式 |
| 内容质量 | `content` | 错别字、语病、表述清晰度、专业术语使用 |
| 逻辑一致性 | `logic` | 前后矛盾、因果关系、数据一致性 |
| 敏感信息 | `sensitive` | 身份证、手机号、密码、商业机密等 |
| 合规检查 | `compliance` | 行业规范、法律法规、引用规范 |

**关键代码**: `app/services/check_service.py`

```python
async def _run_check(self, task_id, content, dimensions, ai_provider_name, custom_rules):
    # 1. 获取 AI 提供商
    ai_provider = get_ai_provider(ai_provider_name)
    
    # 2. 逐维度调用 AI 分析
    for dimension in dimensions:
        result = await ai_provider.analyze(content, dimension, custom_rules)
        results.append(result)
    
    # 3. 生成整体总结
    summary = await ai_provider.generate_summary(content, results)
    
    # 4. 计算综合得分
    overall_score = sum(r.score for r in results) / len(results)
```

---

### 3️⃣ AI 提供商适配层

**文件**: `app/services/ai_providers.py`

```
┌─────────────────────────────────────────────────────────────┐
│                    BaseAIProvider (抽象基类)                 │
│  - analyze(content, dimension) → CheckResult                │
│  - generate_summary(content, results) → str                 │
└──────────────────────────┬──────────────────────────────────┘
                           │
       ┌───────────────────┼───────────────────┐
       ▼                   ▼                   ▼
┌──────────────┐   ┌──────────────┐   ┌──────────────┐
│ OpenAIProvider│   │ClaudeProvider│   │ QwenProvider │
│  GPT-4-turbo │   │   Claude-3   │   │   通义千问    │
└──────────────┘   └──────────────┘   └──────────────┘
```

**核心原理**: 使用精心设计的 **Prompt Engineering**，让 AI 按照结构化格式返回分析结果。

每个维度有专属的检测清单 Prompt，例如格式检测:
```
## 检查清单
### 1. 标题与结构
- 标题层级是否清晰
- 是否存在标题跳级
...
## 评分标准
- 90-100分：格式规范，最多1-2个小问题
- 75-89分：有一些格式问题...
```

---

### 4️⃣ 需求分析流程

**文件**: `app/services/requirement_analyzer.py`

```
上传需求文档 → 解析文本 → 调用AI进行业务视角分析 → 返回结构化结果
```

**分析维度**（业务优先）:
1. **业务流程完整性** - 用户旅程、业务闭环、角色覆盖、状态流转
2. **业务规则清晰度** - 核心规则、金额计算、时间规则、数量限制
3. **异常场景与边界** - 业务异常、操作冲突、数据边界、时间边界
4. **用户体验考量** - 操作反馈、错误引导、撤销回退
5. **运营支撑能力** - 数据统计、人工干预、客诉处理

**输出结构**:
```json
{
  "total_requirements": 3,
  "requirements": [
    {
      "req_id": "REQ-001",
      "title": "会员积分兑换功能",
      "issues": ["[业务流程断点] 积分不足时的用户引导缺失", ...],
      "suggestions": ["补充积分不足引导：显示'还差X积分'", ...]
    }
  ],
  "completeness_score": 55,
  "overall_score": 52,
  "summary": "..."
}
```

---

### 5️⃣ 测试用例生成流程

```
需求文档 → AI理解需求 → 为每个功能生成15-20个测试用例 → 结构化输出
```

**生成的用例类型**:

| 类型 | 说明 |
|-----|------|
| functional | 功能测试（正向场景） |
| boundary | 边界测试（极限值） |
| exception | 异常测试（错误处理） |
| security | 安全测试（SQL注入、XSS等） |
| compatibility | 兼容性测试（多浏览器、多设备） |
| performance | 性能测试（响应时间、并发） |

**测试数据生成器**: `app/services/test_data_generator.py`
- 使用 **Faker** 库生成真实感数据
- 支持中文姓名、手机号、身份证、地址等
- 内置边界值生成器（空值、超长、SQL注入、XSS等）

---

## 📊 数据模型关系

```
DocumentInfo (文档信息)
    │
    ├── CheckRequest → TaskResponse → CheckResult[] → Issue[]
    │                                    │
    │                                    └── dimension, score, summary, issues
    │
    ├── RequirementAnalysisResult → RequirementItem[]
    │                                   │
    │                                   └── req_id, title, issues, suggestions
    │
    └── TestCaseGenerationResult → TestCase[] → TestStep[]
                                      │
                                      └── case_id, title, priority, steps, test_data
```

---

## 🔧 配置与环境变量

**文件**: `app/config.py`

| 配置项 | 作用 |
|-------|------|
| `DEFAULT_AI_PROVIDER` | 默认AI提供商 (openai/anthropic/qwen) |
| `OPENAI_API_KEY` | OpenAI API密钥 |
| `QWEN_API_KEY` | 通义千问API密钥 |
| `ANTHROPIC_API_KEY` | Claude API密钥 |

---

## 🚀 技术栈

| 层面 | 技术 |
|-----|------|
| Web框架 | FastAPI (异步) |
| 文档解析 | PyPDF2, python-docx, openpyxl, python-pptx |
| AI集成 | OpenAI SDK (兼容多家AI) |
| 测试数据 | Faker |
| 数据验证 | Pydantic |
| 异步处理 | asyncio |

---

## 📝 API 接口概览

### 文档管理
- `POST /api/v1/documents/upload` - 上传文档
- `GET /api/v1/documents/{id}` - 获取文档信息
- `GET /api/v1/documents/` - 列出所有文档
- `DELETE /api/v1/documents/{id}` - 删除文档

### 文档检测
- `POST /api/v1/check/start` - 启动检测任务
- `GET /api/v1/check/{task_id}` - 查询任务状态
- `GET /api/v1/check/{task_id}/wait` - 等待任务完成

### 报告生成
- `GET /api/v1/reports/{task_id}/html` - 获取HTML报告
- `GET /api/v1/reports/{task_id}/markdown` - 获取Markdown报告
- `GET /api/v1/reports/{task_id}/json` - 获取JSON报告

### 需求分析
- `POST /api/v1/requirements/analyze` - 分析需求文档
- `GET /api/v1/requirements/analyze/export` - 导出分析结果
- `POST /api/v1/requirements/generate-testcases` - 生成测试用例
- `GET /api/v1/requirements/generate-testcases/export` - 导出测试用例

---

## 📝 总结

这是一个**AI驱动的文档智能分析平台**，核心原理是:

1. **文档解析** - 将多种格式文档转换为纯文本
2. **Prompt Engineering** - 使用精心设计的提示词引导AI进行结构化分析
3. **多维度检测** - 从格式、内容、逻辑等多个角度分析文档
4. **异步处理** - 使用asyncio处理耗时的AI调用，提升用户体验
5. **统一AI接口** - 适配多家AI提供商，灵活切换

**核心价值**: 将AI的自然语言理解能力与结构化的检测框架结合，实现自动化的文档质量检测、需求分析和测试用例生成。
