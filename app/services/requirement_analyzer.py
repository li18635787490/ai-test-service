"""
éœ€æ±‚æ–‡æ¡£åˆ†ææœåŠ¡ - æ£€æµ‹éœ€æ±‚å®Œæ•´æ€§ã€åœºæ™¯è¦†ç›–ã€æè¿°è´¨é‡
"""
import json
from typing import Optional, List
from datetime import datetime

from app.config import get_settings
from app.models import (
    RequirementAnalysisResult, RequirementItem,
    TestCase, TestStep, TestCaseGenerationResult,
    TestCasePriority, TestCaseType
)
from app.services.ai_providers import get_ai_provider


class RequirementAnalyzer:
    """éœ€æ±‚æ–‡æ¡£åˆ†æå™¨"""

    def __init__(self, ai_provider_name: Optional[str] = None):
        self.ai_provider = get_ai_provider(ai_provider_name)

    async def analyze_requirements(self, content: str) -> RequirementAnalysisResult:
        """åˆ†æéœ€æ±‚æ–‡æ¡£"""
        prompt = """ä½ æ˜¯ä¸€ä¸ªæ‹¥æœ‰10å¹´ç»éªŒçš„**ä¸šåŠ¡åˆ†æå¸ˆå’Œäº§å“ç»ç†**ã€‚è¯·ç«™åœ¨ä¸šåŠ¡è§†è§’å¯¹éœ€æ±‚æ–‡æ¡£è¿›è¡Œæ·±åº¦åˆ†æï¼Œé‡ç‚¹å…³æ³¨**ä¸šåŠ¡é€»è¾‘ã€ç”¨æˆ·ä½“éªŒã€å•†ä¸šä»·å€¼**å±‚é¢çš„é—®é¢˜ã€‚

## ğŸ¯ åˆ†æè§†è§’ï¼ˆä¸šåŠ¡ä¼˜å…ˆï¼‰

ä½ éœ€è¦åƒä¸€ä¸ªçœŸæ­£ç†è§£ä¸šåŠ¡çš„äº§å“ç»ç†ä¸€æ ·æ€è€ƒï¼š
- è¿™ä¸ªåŠŸèƒ½è§£å†³äº†ç”¨æˆ·ä»€ä¹ˆç—›ç‚¹ï¼Ÿ
- ä¸šåŠ¡æµç¨‹æ˜¯å¦å®Œæ•´é—­ç¯ï¼Ÿ
- ä¼šä¸ä¼šæœ‰ç”¨æˆ·è¢«"å¡ä½"çš„æƒ…å†µï¼Ÿ
- è¿™ä¸ªè®¾è®¡ç¬¦åˆè¡Œä¸šæƒ¯ä¾‹å—ï¼Ÿ
- è¿è¥å’Œå®¢æœèƒ½æ”¯æ’‘å—ï¼Ÿ

## ğŸ“‹ ä¸šåŠ¡åˆ†ææ¸…å•ï¼ˆé’ˆå¯¹æ¯ä¸ªåŠŸèƒ½ç‚¹ï¼‰

### 1. ä¸šåŠ¡æµç¨‹å®Œæ•´æ€§
- **ç”¨æˆ·æ—…ç¨‹**ï¼šç”¨æˆ·ä»å“ªé‡Œæ¥ï¼Ÿå®Œæˆåå»å“ªé‡Œï¼Ÿä¸­é€”æ”¾å¼ƒæ€ä¹ˆåŠï¼Ÿ
- **ä¸šåŠ¡é—­ç¯**ï¼šæµç¨‹æ˜¯å¦æœ‰å§‹æœ‰ç»ˆï¼Ÿæ˜¯å¦æœ‰"æ–­å¤´è·¯"ï¼Ÿ
- **è§’è‰²è¦†ç›–**ï¼šæ¶‰åŠå“ªäº›è§’è‰²ï¼ˆç”¨æˆ·/å•†å®¶/è¿è¥/å®¢æœï¼‰ï¼Ÿå„è§’è‰²çš„æ“ä½œæ˜¯å¦éƒ½è¯´æ¸…æ¥šäº†ï¼Ÿ
- **çŠ¶æ€æµè½¬**ï¼šä¸šåŠ¡çŠ¶æ€æœ‰å“ªäº›ï¼ŸçŠ¶æ€ä¹‹é—´å¦‚ä½•è½¬æ¢ï¼Ÿèƒ½å¦é€†å‘æ“ä½œï¼Ÿ

### 2. ä¸šåŠ¡è§„åˆ™æ¸…æ™°åº¦
- **æ ¸å¿ƒè§„åˆ™**ï¼šä¸šåŠ¡çš„å…³é”®åˆ¤æ–­é€»è¾‘æ˜¯ä»€ä¹ˆï¼Ÿæ¡ä»¶æ˜¯å¦æ˜ç¡®ï¼Ÿ
- **é‡‘é¢è®¡ç®—**ï¼šæ¶‰åŠé‡‘é¢æ—¶ï¼Œè®¡ç®—å…¬å¼æ˜¯å¦æ¸…æ™°ï¼Ÿç²¾åº¦å¦‚ä½•å¤„ç†ï¼Ÿ
- **æ—¶é—´è§„åˆ™**ï¼šæœ‰æ•ˆæœŸã€è¿‡æœŸå¤„ç†ã€æ—¶åŒºé—®é¢˜æ˜¯å¦è€ƒè™‘ï¼Ÿ
- **æ•°é‡é™åˆ¶**ï¼šä¸šåŠ¡ä¸Šçš„é™åˆ¶æ¡ä»¶æ˜¯å¦è¯´æ˜ï¼Ÿï¼ˆå¦‚ï¼šæ¯äººé™è´­Xä»¶ï¼‰

### 3. å¼‚å¸¸åœºæ™¯ä¸è¾¹ç•Œ
- **ä¸šåŠ¡å¼‚å¸¸**ï¼šåº“å­˜ä¸è¶³ã€ä½™é¢ä¸å¤Ÿã€èµ„æ ¼ä¸ç¬¦ç­‰ä¸šåŠ¡åœºæ™¯å¦‚ä½•å¤„ç†ï¼Ÿ
- **æ“ä½œå†²çª**ï¼šå¤šäººåŒæ—¶æ“ä½œæ€ä¹ˆåŠï¼Ÿé‡å¤æäº¤æ€ä¹ˆåŠï¼Ÿ
- **æ•°æ®è¾¹ç•Œ**ï¼š0çš„æƒ…å†µã€è´Ÿæ•°çš„æƒ…å†µã€è¶…å¤§æ•°çš„æƒ…å†µ
- **æ—¶é—´è¾¹ç•Œ**ï¼šè·¨å¤©ã€è·¨æœˆã€èŠ‚å‡æ—¥ç­‰ç‰¹æ®Šæ—¶é—´ç‚¹

### 4. ç”¨æˆ·ä½“éªŒè€ƒé‡
- **æ“ä½œåé¦ˆ**ï¼šç”¨æˆ·æ“ä½œåèƒ½çœ‹åˆ°ä»€ä¹ˆåé¦ˆï¼Ÿ
- **é”™è¯¯å¼•å¯¼**ï¼šå‡ºé”™æ—¶ç”¨æˆ·çŸ¥é“è¯¥æ€ä¹ˆåŠå—ï¼Ÿ
- **æ’¤é”€å›é€€**ï¼šç”¨æˆ·æ“ä½œé”™äº†èƒ½æ’¤é”€å—ï¼Ÿ
- **æ–°æ‰‹å¼•å¯¼**ï¼šé¦–æ¬¡ä½¿ç”¨çš„ç”¨æˆ·èƒ½é¡ºåˆ©å®Œæˆå—ï¼Ÿ

### 5. è¿è¥æ”¯æ’‘èƒ½åŠ›
- **æ•°æ®ç»Ÿè®¡**ï¼šè¿è¥éœ€è¦çœ‹å“ªäº›æ•°æ®ï¼Ÿæ˜¯å¦æ”¯æŒï¼Ÿ
- **äººå·¥å¹²é¢„**ï¼šéœ€è¦äººå·¥å¤„ç†çš„åœºæ™¯æœ‰å“ªäº›ï¼Ÿåå°åŠŸèƒ½æ˜¯å¦æ”¯æŒï¼Ÿ
- **å®¢è¯‰å¤„ç†**ï¼šå‡ºé—®é¢˜æ—¶å®¢æœå¦‚ä½•æŸ¥è¯¢å’Œå¤„ç†ï¼Ÿ
- **ç°åº¦ä¸Šçº¿**ï¼šæ˜¯å¦éœ€è¦åˆ†æ‰¹æ”¾é‡ï¼Ÿå¦‚ä½•æ§åˆ¶ï¼Ÿ

## ğŸ“¤ è¾“å‡ºæ ¼å¼ï¼ˆJSONï¼‰ï¼š

{
    "total_requirements": 3,
    "requirements": [
        {
            "req_id": "REQ-001",
            "title": "ä¼šå‘˜ç§¯åˆ†å…‘æ¢åŠŸèƒ½",
            "description": "ç”¨æˆ·å¯ç”¨ç§¯åˆ†å…‘æ¢ä¼˜æƒ åˆ¸æˆ–ç¤¼å“",
            "priority": "é«˜",
            "issues": [
                "[ä¸šåŠ¡æµç¨‹æ–­ç‚¹] ç§¯åˆ†ä¸è¶³æ—¶çš„ç”¨æˆ·å¼•å¯¼ç¼ºå¤±ï¼šç”¨æˆ·çœ‹åˆ°æƒ³å…‘æ¢çš„å•†å“ä½†ç§¯åˆ†ä¸å¤Ÿï¼Œæ²¡æœ‰è¯´æ˜å¦‚ä½•å¼•å¯¼ç”¨æˆ·å»èµšå–ç§¯åˆ†",
                "[è§„åˆ™ä¸æ˜ç¡®] ç§¯åˆ†æœ‰æ•ˆæœŸè§„åˆ™æœªè¯´æ˜ï¼šç§¯åˆ†æ˜¯å¦ä¼šè¿‡æœŸï¼Ÿè¿‡æœŸå‰æ˜¯å¦æé†’ï¼Ÿå³å°†è¿‡æœŸçš„ç§¯åˆ†æ˜¯å¦ä¼˜å…ˆä½¿ç”¨ï¼Ÿ",
                "[å¹¶å‘åœºæ™¯é—æ¼] çƒ­é—¨å•†å“æŠ¢å…‘åœºæ™¯æœªè€ƒè™‘ï¼šé™é‡å•†å“å¤šäººåŒæ—¶å…‘æ¢æ—¶çš„åº“å­˜æ‰£å‡å’Œå¤±è´¥å¤„ç†",
                "[é€†å‘æµç¨‹ç¼ºå¤±] å…‘æ¢åçš„é€€æ¢è§„åˆ™æœªè¯´æ˜ï¼šç¤¼å“æœ‰è´¨é‡é—®é¢˜æ€ä¹ˆåŠï¼Ÿä¼˜æƒ åˆ¸å…‘æ¢åèƒ½å¦é€€å›ç§¯åˆ†ï¼Ÿ",
                "[è¿è¥èƒ½åŠ›ç¼ºå¤±] ç§¯åˆ†å‘æ”¾å’Œæ‰£å‡çš„åå°ç®¡ç†åŠŸèƒ½æœªæåŠï¼šè¿è¥å¦‚ä½•æ‰‹åŠ¨è¡¥å‘ç§¯åˆ†ï¼Ÿå¦‚ä½•æŸ¥è¯¢ç”¨æˆ·ç§¯åˆ†æ˜ç»†ï¼Ÿ"
            ],
            "suggestions": [
                "è¡¥å……ç§¯åˆ†ä¸è¶³å¼•å¯¼ï¼šæ˜¾ç¤º'è¿˜å·®Xç§¯åˆ†'ï¼Œæä¾›'å»èµšç§¯åˆ†'å…¥å£ï¼Œå±•ç¤ºç§¯åˆ†è·å–é€”å¾„",
                "æ˜ç¡®ç§¯åˆ†æœ‰æ•ˆæœŸï¼šç§¯åˆ†è‡ªè·å¾—ä¹‹æ—¥èµ·12ä¸ªæœˆæœ‰æ•ˆï¼Œåˆ°æœŸå‰30å¤©çŸ­ä¿¡/pushæé†’ï¼Œä½¿ç”¨æ—¶ä¼˜å…ˆæ‰£é™¤å³å°†è¿‡æœŸç§¯åˆ†",
                "æ·»åŠ åº“å­˜é”å®šæœºåˆ¶ï¼šç”¨æˆ·ç‚¹å‡»å…‘æ¢åé”å®šåº“å­˜5åˆ†é’Ÿï¼Œè¶…æ—¶æœªæ”¯ä»˜è‡ªåŠ¨é‡Šæ”¾ï¼ŒåŒæ—¶ç»™å‡ºæ’é˜Ÿæç¤º",
                "è¡¥å……é€€æ¢è§„åˆ™ï¼šå®ç‰©å•†å“ç­¾æ”¶å7å¤©å†…å¯ç”³è¯·é€€æ¢ï¼Œä¼˜æƒ åˆ¸ä¸€ç»å…‘æ¢ä¸å¯é€€å›",
                "å¢åŠ è¿è¥åå°éœ€æ±‚ï¼šæ”¯æŒæŒ‰ç”¨æˆ·IDæŸ¥è¯¢ç§¯åˆ†æ˜ç»†ï¼Œæ”¯æŒæ‰¹é‡å‘æ”¾ç§¯åˆ†ï¼Œæ”¯æŒç§¯åˆ†å†»ç»“/è§£å†»"
            ]
        },
        {
            "req_id": "REQ-002",
            "title": "è®¢å•å–æ¶ˆåŠŸèƒ½",
            "description": "ç”¨æˆ·å¯ä»¥å–æ¶ˆæœªå‘è´§çš„è®¢å•",
            "priority": "é«˜",
            "issues": [
                "[çŠ¶æ€å®šä¹‰ä¸æ¸…] 'æœªå‘è´§'çš„å‡†ç¡®å®šä¹‰ä¸æ˜ç¡®ï¼šæ˜¯å•†å®¶æœªç‚¹å‘è´§ï¼Ÿè¿˜æ˜¯ç‰©æµæœªæ½æ”¶ï¼Ÿå•†å®¶å·²æ‰“åŒ…ä½†æœªå‘è´§ç®—ä»€ä¹ˆçŠ¶æ€ï¼Ÿ",
                "[èµ„é‡‘æµè½¬é—æ¼] é€€æ¬¾è§„åˆ™æœªè¯´æ˜ï¼šå–æ¶ˆåå¤šä¹…é€€æ¬¾ï¼Ÿé€€åˆ°å“ªé‡Œï¼Ÿä½¿ç”¨äº†ä¼˜æƒ åˆ¸/ç§¯åˆ†å¦‚ä½•å¤„ç†ï¼Ÿ",
                "[åº“å­˜å›æ»šç¼ºå¤±] å–æ¶ˆè®¢å•åçš„åº“å­˜å¤„ç†æœªè¯´æ˜ï¼šåº“å­˜æ˜¯å¦ç«‹å³å›æ»šï¼Ÿæ˜¯å¦å½±å“å…¶ä»–ç”¨æˆ·ä¸‹å•ï¼Ÿ",
                "[é€šçŸ¥æœºåˆ¶ç¼ºå¤±] å–æ¶ˆåçš„é€šçŸ¥ç­–ç•¥æœªè¯´æ˜ï¼šæ˜¯å¦é€šçŸ¥å•†å®¶ï¼Ÿé€šçŸ¥æ–¹å¼æ˜¯ä»€ä¹ˆï¼Ÿå•†å®¶å¤šä¹…å†…éœ€ç¡®è®¤ï¼Ÿ",
                "[å”®åè¡”æ¥é—®é¢˜] å–æ¶ˆå’Œå”®åçš„å…³ç³»æœªè¯´æ˜ï¼šå·²ç”³è¯·å”®åçš„è®¢å•èƒ½å¦å–æ¶ˆï¼Ÿå–æ¶ˆåçš„å”®åå•å¦‚ä½•å¤„ç†ï¼Ÿ"
            ],
            "suggestions": [
                "æ˜ç¡®çŠ¶æ€å®šä¹‰ï¼š'æœªå‘è´§'=å•†å®¶æœªç‚¹å‡»å‘è´§æŒ‰é’®ï¼›'å·²å‘è´§å¾…æ½æ”¶'çŠ¶æ€ä¸‹å–æ¶ˆéœ€èµ°æ‹¦æˆªæµç¨‹",
                "è¡¥å……é€€æ¬¾è§„åˆ™ï¼šå–æ¶ˆæˆåŠŸå24å°æ—¶å†…åŸè·¯é€€å›ï¼›ä¼˜æƒ åˆ¸é€€å›è´¦æˆ·ï¼ˆæœ‰æ•ˆæœŸé¡ºå»¶7å¤©ï¼‰ï¼›ç§¯åˆ†å³æ—¶è¿”è¿˜",
                "è¡¥å……åº“å­˜è§„åˆ™ï¼šæ™®é€šå•†å“å–æ¶ˆååº“å­˜å³æ—¶å›æ»šï¼›ç§’æ€/é™è´­å•†å“å›æ»šåä¸å†å¼€æ”¾",
                "è¡¥å……é€šçŸ¥æœºåˆ¶ï¼šå–æ¶ˆåå®æ—¶pushé€šçŸ¥å•†å®¶ï¼Œå•†å®¶2å°æ—¶å†…æœªç¡®è®¤è‡ªåŠ¨åŒæ„ï¼Œè¶…æ—¶å‡çº§è‡³å¹³å°å¤„ç†",
                "æ˜ç¡®å”®åå…³ç³»ï¼šå·²æœ‰è¿›è¡Œä¸­å”®åå•çš„è®¢å•ä¸å¯æ•´å•å–æ¶ˆï¼Œéœ€å…ˆå®Œæˆæˆ–å…³é—­å”®å"
            ]
        }
    ],
    "completeness_score": 55,
    "scenario_coverage_score": 45,
    "description_quality_score": 60,
    "testability_score": 50,
    "overall_score": 52,
    "summary": "è¯¥æ–‡æ¡£å…±åŒ…å«Xä¸ªåŠŸèƒ½ç‚¹ã€‚ä¸»è¦é—®é¢˜ï¼š1ï¼‰Xä¸ªåŠŸèƒ½çš„ä¸šåŠ¡æµç¨‹å­˜åœ¨æ–­ç‚¹ï¼Œç”¨æˆ·å¯èƒ½è¢«å¡ä½ 2ï¼‰Xä¸ªåŠŸèƒ½ç¼ºå°‘å¼‚å¸¸åœºæ™¯å¤„ç†ï¼Œå¯èƒ½å¯¼è‡´å®¢è¯‰ 3ï¼‰è¿è¥åå°æ”¯æ’‘èƒ½åŠ›æ™®éä¸è¶³ã€‚å»ºè®®ä¼˜å…ˆè¡¥å……æ ¸å¿ƒåŠŸèƒ½çš„å¼‚å¸¸å¤„ç†å’Œé€†å‘æµç¨‹ã€‚",
    "improvement_suggestions": [
        "[é«˜ä¼˜å…ˆçº§] ä¸ºæ¯ä¸ªåŠŸèƒ½æ¢³ç†å®Œæ•´çš„ç”¨æˆ·æ—…ç¨‹ï¼Œç¡®ä¿æµç¨‹é—­ç¯æ— æ–­ç‚¹ï¼Œç‰¹åˆ«æ˜¯å¼‚å¸¸æƒ…å†µä¸‹çš„ç”¨æˆ·å¼•å¯¼",
        "[é«˜ä¼˜å…ˆçº§] è¡¥å……èµ„é‡‘ç›¸å…³è§„åˆ™ï¼šæ¶‰åŠé‡‘é¢çš„åŠŸèƒ½å¿…é¡»è¯´æ˜è®¡ç®—å…¬å¼ã€ç²¾åº¦å¤„ç†ã€é€€æ¬¾è§„åˆ™",
        "[ä¸­ä¼˜å…ˆçº§] æ¯ä¸ªåŠŸèƒ½è¡¥å……çŠ¶æ€æµè½¬å›¾ï¼Œæ˜ç¡®å„çŠ¶æ€çš„å®šä¹‰å’Œè½¬æ¢æ¡ä»¶ï¼Œç‰¹åˆ«æ˜¯é€†å‘çŠ¶æ€",
        "[ä¸­ä¼˜å…ˆçº§] è¡¥å……è¿è¥åå°éœ€æ±‚ï¼Œç¡®ä¿æ¯ä¸ªä¸šåŠ¡åŠŸèƒ½éƒ½æœ‰å¯¹åº”çš„åå°æŸ¥è¯¢å’Œå¤„ç†èƒ½åŠ›",
        "[å»ºè®®] ç»„ç»‡ä¸šåŠ¡è¯„å®¡ä¼šè®®ï¼Œé‚€è¯·å®¢æœã€è¿è¥ä¸€èµ·è¯„å®¡ï¼Œæå‰å‘ç°å®é™…è¿è¥ä¸­å¯èƒ½é‡åˆ°çš„é—®é¢˜"
    ]
}

## âš ï¸ å…³é”®è¦æ±‚ï¼š

1. **ä¸šåŠ¡è§†è§’ä¼˜å…ˆ**ï¼šé—®é¢˜è¦ä»ä¸šåŠ¡å½±å“è§’åº¦æè¿°ï¼ˆå¦‚"ç”¨æˆ·ä¼šè¢«å¡ä½"ã€"å¯èƒ½å¯¼è‡´å®¢è¯‰"ï¼‰ï¼Œè€Œä¸æ˜¯çº¯æŠ€æœ¯è§†è§’
2. **é—®é¢˜ç±»å‹**ä½¿ç”¨ä»¥ä¸‹æ ‡ç­¾ï¼š
   - `[ä¸šåŠ¡æµç¨‹æ–­ç‚¹]` - ç”¨æˆ·æ—…ç¨‹ä¸­æ–­ã€æµç¨‹ä¸é—­ç¯
   - `[è§„åˆ™ä¸æ˜ç¡®]` - ä¸šåŠ¡è§„åˆ™ã€è®¡ç®—é€»è¾‘ä¸æ¸…æ™°
   - `[çŠ¶æ€å®šä¹‰ä¸æ¸…]` - ä¸šåŠ¡çŠ¶æ€åŠæµè½¬è§„åˆ™æ¨¡ç³Š
   - `[å¹¶å‘åœºæ™¯é—æ¼]` - å¤šç”¨æˆ·/å¤šæ“ä½œå†²çªæœªè€ƒè™‘
   - `[é€†å‘æµç¨‹ç¼ºå¤±]` - é€€æ¬¾/é€€è´§/å–æ¶ˆ/æ’¤é”€ç­‰é€†å‘æ“ä½œæœªè¯´æ˜
   - `[è¿è¥èƒ½åŠ›ç¼ºå¤±]` - ç¼ºå°‘è¿è¥åå°/æ•°æ®ç»Ÿè®¡/äººå·¥å¹²é¢„èƒ½åŠ›
   - `[é€šçŸ¥æœºåˆ¶ç¼ºå¤±]` - ç”¨æˆ·/å•†å®¶/è¿è¥çš„é€šçŸ¥æé†’æœªè¯´æ˜
   - `[å¼‚å¸¸å¤„ç†ç¼ºå¤±]` - ä¸šåŠ¡å¼‚å¸¸åœºæ™¯ï¼ˆåº“å­˜ä¸è¶³ã€ä½™é¢ä¸å¤Ÿç­‰ï¼‰æœªå¤„ç†
   - `[è¾¹ç•Œåœºæ™¯é—æ¼]` - ç‰¹æ®Šæƒ…å†µï¼ˆ0å€¼ã€æé™å€¼ã€ç‰¹æ®Šæ—¶é—´ç‚¹ï¼‰æœªè€ƒè™‘
3. **å»ºè®®è¦å¯è½åœ°**ï¼šå»ºè®®è¦å…·ä½“åˆ°ä¸šåŠ¡è§„åˆ™ï¼ˆå¦‚"12ä¸ªæœˆæœ‰æ•ˆæœŸ"ã€"30å¤©æé†’"ï¼‰ï¼Œè€Œä¸æ˜¯æ³›æ³›è€Œè°ˆ
4. **ä¸¥ç¦é›·åŒ**ï¼šæ¯ä¸ªéœ€æ±‚çš„issueså’Œsuggestionså¿…é¡»é’ˆå¯¹å…¶å…·ä½“ä¸šåŠ¡å†…å®¹ï¼Œä¸èƒ½å¤åˆ¶ç²˜è´´

åªè¿”å› JSONï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚
"""

        try:
            response = await self.ai_provider.client.chat.completions.create(
                model=self.ai_provider.model,
                messages=[
                    {"role": "system", "content": prompt},
                    {"role": "user", "content": f"è¯·åˆ†æä»¥ä¸‹éœ€æ±‚æ–‡æ¡£ï¼š\n\n{content}"}
                ],
                temperature=0.3
            )

            result_text = response.choices[0].message.content
            result_text = self._clean_json(result_text)
            data = json.loads(result_text)

            # è§£æéœ€æ±‚é¡¹
            requirements = []
            for req in data.get("requirements", []):
                requirements.append(RequirementItem(
                    req_id=req.get("req_id", ""),
                    title=req.get("title", ""),
                    description=req.get("description", ""),
                    priority=req.get("priority"),
                    issues=req.get("issues", []),
                    suggestions=req.get("suggestions", [])
                ))

            return RequirementAnalysisResult(
                total_requirements=data.get("total_requirements", len(requirements)),
                analyzed_requirements=requirements,
                completeness_score=float(data.get("completeness_score", 0)),
                scenario_coverage_score=float(data.get("scenario_coverage_score", 0)),
                description_quality_score=float(data.get("description_quality_score", 0)),
                testability_score=float(data.get("testability_score", 0)),
                overall_score=float(data.get("overall_score", 0)),
                summary=data.get("summary", ""),
                improvement_suggestions=data.get("improvement_suggestions", [])
            )

        except Exception as e:
            raise Exception(f"éœ€æ±‚åˆ†æå¤±è´¥: {str(e)}")

    async def generate_test_cases(self, content: str, document_id: str) -> TestCaseGenerationResult:
        """æ ¹æ®éœ€æ±‚æ–‡æ¡£ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹"""
        prompt = """ä½ æ˜¯ä¸€ä¸ªèµ„æ·±çš„æµ‹è¯•å·¥ç¨‹å¸ˆã€‚è¯·æ ¹æ®éœ€æ±‚æ–‡æ¡£ä¸ºæ¯ä¸ªåŠŸèƒ½ç‚¹ç”Ÿæˆ**è¯¦ç»†ã€å…·ä½“ã€å¯æ‰§è¡Œ**çš„æµ‹è¯•ç”¨ä¾‹ã€‚

## æµ‹è¯•ç”¨ä¾‹è®¾è®¡åŸåˆ™

1. **å…·ä½“åŒ–**ï¼šæ¯ä¸ªæ­¥éª¤å¿…é¡»å…·ä½“åˆ°å¯ä»¥ç›´æ¥æ‰§è¡Œï¼Œä¸èƒ½æœ‰æ¨¡ç³Šæè¿°
2. **æ•°æ®é©±åŠ¨**ï¼šå¿…é¡»æä¾›å…·ä½“çš„æµ‹è¯•æ•°æ®ï¼Œä¸èƒ½åªè¯´"è¾“å…¥æ•°æ®"
3. **å…¨é¢è¦†ç›–**ï¼šæ¯ä¸ªåŠŸèƒ½è‡³å°‘åŒ…å«æ­£å‘ã€åå‘ã€è¾¹ç•Œä¸‰ç±»ç”¨ä¾‹
4. **å¯éªŒè¯**ï¼šé¢„æœŸç»“æœå¿…é¡»æ˜ç¡®ï¼Œèƒ½å¤Ÿåˆ¤æ–­æµ‹è¯•æ˜¯å¦é€šè¿‡

## æ¯ä¸ªåŠŸèƒ½éœ€è¦è®¾è®¡çš„æµ‹è¯•ç±»å‹

### æ­£å‘æµ‹è¯•ï¼ˆP0/P1ï¼‰
- æ­£å¸¸æµç¨‹èƒ½å¦èµ°é€š
- ä½¿ç”¨æœ‰æ•ˆæ•°æ®æ˜¯å¦å¾—åˆ°æ­£ç¡®ç»“æœ

### åå‘æµ‹è¯•ï¼ˆP1/P2ï¼‰  
- å¿…å¡«é¡¹ä¸ºç©ºæ—¶çš„æç¤º
- æ•°æ®æ ¼å¼é”™è¯¯æ—¶çš„å¤„ç†
- æƒé™ä¸è¶³æ—¶çš„æç¤º
- ä¸šåŠ¡è§„åˆ™ä¸æ»¡è¶³æ—¶çš„å¤„ç†

### è¾¹ç•Œæµ‹è¯•ï¼ˆP1/P2ï¼‰
- æœ€å°å€¼ã€æœ€å¤§å€¼
- é•¿åº¦è¾¹ç•Œï¼ˆåˆšå¥½ã€è¶…å‡ºä¸€ä½ï¼‰
- æ•°é‡è¾¹ç•Œï¼ˆ0ä¸ªã€1ä¸ªã€æœ€å¤§ä¸ªæ•°ï¼‰

### å¼‚å¸¸æµ‹è¯•ï¼ˆP2/P3ï¼‰
- ç½‘ç»œå¼‚å¸¸æ—¶çš„å¤„ç†
- æœåŠ¡è¶…æ—¶çš„å¤„ç†
- å¹¶å‘æ“ä½œçš„å¤„ç†

## è¾“å‡ºæ ¼å¼ï¼ˆJSONï¼‰ï¼š

{
    "test_cases": [
        {
            "case_id": "TC-LOGIN-001",
            "requirement_id": "REQ-001",
            "title": "ã€æ­£å‘ã€‘ä½¿ç”¨æ­£ç¡®çš„ç”¨æˆ·åå¯†ç ç™»å½•æˆåŠŸ",
            "priority": "P0",
            "case_type": "functional",
            "precondition": "1. ç”¨æˆ·å·²æ³¨å†Œè´¦å· test001ï¼Œå¯†ç ä¸º Test@123456\\n2. è´¦å·çŠ¶æ€æ­£å¸¸ï¼Œæœªè¢«é”å®š",
            "steps": [
                {"step_number": 1, "action": "æ‰“å¼€ç™»å½•é¡µé¢ https://xxx.com/login", "expected_result": "æ˜¾ç¤ºç™»å½•é¡µé¢ï¼ŒåŒ…å«ç”¨æˆ·åã€å¯†ç è¾“å…¥æ¡†å’Œç™»å½•æŒ‰é’®"},
                {"step_number": 2, "action": "åœ¨ç”¨æˆ·åè¾“å…¥æ¡†è¾“å…¥ï¼štest001", "expected_result": "ç”¨æˆ·åæ­£ç¡®æ˜¾ç¤º"},
                {"step_number": 3, "action": "åœ¨å¯†ç è¾“å…¥æ¡†è¾“å…¥ï¼šTest@123456", "expected_result": "å¯†ç ä»¥å¯†æ–‡å½¢å¼æ˜¾ç¤º"},
                {"step_number": 4, "action": "ç‚¹å‡»ã€ç™»å½•ã€‘æŒ‰é’®", "expected_result": "1. æ˜¾ç¤ºåŠ è½½çŠ¶æ€\\n2. ç™»å½•æˆåŠŸï¼Œè·³è½¬åˆ°é¦–é¡µ\\n3. é¡µé¢å³ä¸Šè§’æ˜¾ç¤ºç”¨æˆ·å test001"}
            ],
            "test_data": "ç”¨æˆ·åï¼štest001ï¼Œå¯†ç ï¼šTest@123456",
            "tags": ["ç™»å½•", "P0", "å†’çƒŸæµ‹è¯•"]
        },
        {
            "case_id": "TC-LOGIN-002",
            "requirement_id": "REQ-001", 
            "title": "ã€åå‘ã€‘å¯†ç é”™è¯¯æ—¶æç¤ºé”™è¯¯ä¿¡æ¯",
            "priority": "P1",
            "case_type": "exception",
            "precondition": "ç”¨æˆ·å·²æ³¨å†Œè´¦å· test001ï¼Œæ­£ç¡®å¯†ç ä¸º Test@123456",
            "steps": [
                {"step_number": 1, "action": "æ‰“å¼€ç™»å½•é¡µé¢", "expected_result": "æ˜¾ç¤ºç™»å½•é¡µé¢"},
                {"step_number": 2, "action": "è¾“å…¥ç”¨æˆ·åï¼štest001", "expected_result": "ç”¨æˆ·åæ­£ç¡®æ˜¾ç¤º"},
                {"step_number": 3, "action": "è¾“å…¥é”™è¯¯å¯†ç ï¼šwrongpassword", "expected_result": "å¯†ç ä»¥å¯†æ–‡å½¢å¼æ˜¾ç¤º"},
                {"step_number": 4, "action": "ç‚¹å‡»ã€ç™»å½•ã€‘æŒ‰é’®", "expected_result": "1. æç¤º"ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"\\n2. åœç•™åœ¨ç™»å½•é¡µé¢\\n3. å¯†ç æ¡†æ¸…ç©º"}
            ],
            "test_data": "ç”¨æˆ·åï¼štest001ï¼Œé”™è¯¯å¯†ç ï¼šwrongpassword",
            "tags": ["ç™»å½•", "å¼‚å¸¸å¤„ç†"]
        },
        {
            "case_id": "TC-LOGIN-003",
            "requirement_id": "REQ-001",
            "title": "ã€è¾¹ç•Œã€‘å¯†ç é•¿åº¦ä¸ºæœ€å°å€¼8ä½æ—¶ç™»å½•",
            "priority": "P2",
            "case_type": "boundary",
            "precondition": "ç”¨æˆ·å·²æ³¨å†Œï¼Œå¯†ç è®¾ç½®ä¸º8ä½ï¼šAa@12345",
            "steps": [
                {"step_number": 1, "action": "æ‰“å¼€ç™»å½•é¡µé¢", "expected_result": "æ˜¾ç¤ºç™»å½•é¡µé¢"},
                {"step_number": 2, "action": "è¾“å…¥ç”¨æˆ·åå’Œ8ä½å¯†ç ï¼šAa@12345", "expected_result": "è¾“å…¥æˆåŠŸ"},
                {"step_number": 3, "action": "ç‚¹å‡»ç™»å½•", "expected_result": "ç™»å½•æˆåŠŸ"}
            ],
            "test_data": "8ä½å¯†ç ï¼šAa@12345",
            "tags": ["ç™»å½•", "è¾¹ç•Œæµ‹è¯•"]
        }
    ],
    "coverage_summary": "å…±ç”ŸæˆXä¸ªæµ‹è¯•ç”¨ä¾‹ï¼Œè¦†ç›–Xä¸ªåŠŸèƒ½ç‚¹ã€‚å…¶ä¸­P0ç”¨ä¾‹Xä¸ªï¼ŒP1ç”¨ä¾‹Xä¸ªï¼ŒP2ç”¨ä¾‹Xä¸ªã€‚è¦†ç›–äº†æ­£å‘æµç¨‹ã€å¼‚å¸¸å¤„ç†ã€è¾¹ç•Œæ¡ä»¶ç­‰åœºæ™¯ã€‚"
}

## é‡è¦è¦æ±‚ï¼š
1. case_id æ ¼å¼ï¼šTC-åŠŸèƒ½æ¨¡å—-åºå·ï¼Œå¦‚ TC-LOGIN-001ã€TC-ORDER-001
2. title å¿…é¡»ä»¥ã€æ­£å‘ã€‘ã€åå‘ã€‘ã€è¾¹ç•Œã€‘ã€å¼‚å¸¸ã€‘å¼€å¤´ï¼Œæ˜ç¡®ç”¨ä¾‹ç±»å‹
3. steps ä¸­çš„ action å¿…é¡»å…·ä½“åˆ°"è¾“å…¥ä»€ä¹ˆå†…å®¹"ã€"ç‚¹å‡»ä»€ä¹ˆæŒ‰é’®"
4. expected_result å¿…é¡»å…·ä½“åˆ°"æ˜¾ç¤ºä»€ä¹ˆæ–‡å­—"ã€"è·³è½¬åˆ°ä»€ä¹ˆé¡µé¢"
5. test_data å¿…é¡»æä¾›å…·ä½“çš„æµ‹è¯•æ•°æ®å€¼

åªè¿”å› JSONï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚
"""

        try:
            response = await self.ai_provider.client.chat.completions.create(
                model=self.ai_provider.model,
                messages=[
                    {"role": "system", "content": prompt},
                    {"role": "user", "content": f"è¯·æ ¹æ®ä»¥ä¸‹éœ€æ±‚æ–‡æ¡£ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹ï¼š\n\n{content}"}
                ],
                temperature=0.3
            )

            result_text = response.choices[0].message.content
            result_text = self._clean_json(result_text)
            data = json.loads(result_text)

            # è§£ææµ‹è¯•ç”¨ä¾‹
            test_cases = []
            for tc in data.get("test_cases", []):
                steps = []
                for step in tc.get("steps", []):
                    steps.append(TestStep(
                        step_number=step.get("step_number", 1),
                        action=step.get("action", ""),
                        expected_result=step.get("expected_result", "")
                    ))

                # è§£æä¼˜å…ˆçº§
                priority_map = {"P0": TestCasePriority.P0, "P1": TestCasePriority.P1,
                               "P2": TestCasePriority.P2, "P3": TestCasePriority.P3}
                priority = priority_map.get(tc.get("priority", "P2"), TestCasePriority.P2)

                # è§£æç±»å‹
                type_map = {
                    "functional": TestCaseType.FUNCTIONAL,
                    "boundary": TestCaseType.BOUNDARY,
                    "exception": TestCaseType.EXCEPTION,
                    "performance": TestCaseType.PERFORMANCE,
                    "security": TestCaseType.SECURITY
                }
                case_type = type_map.get(tc.get("case_type", "functional"), TestCaseType.FUNCTIONAL)

                test_cases.append(TestCase(
                    case_id=tc.get("case_id", ""),
                    requirement_id=tc.get("requirement_id"),
                    title=tc.get("title", ""),
                    priority=priority,
                    case_type=case_type,
                    precondition=tc.get("precondition"),
                    steps=steps,
                    test_data=tc.get("test_data"),
                    tags=tc.get("tags", [])
                ))

            return TestCaseGenerationResult(
                document_id=document_id,
                total_cases=len(test_cases),
                test_cases=test_cases,
                coverage_summary=data.get("coverage_summary", ""),
                generated_at=datetime.now()
            )

        except Exception as e:
            raise Exception(f"æµ‹è¯•ç”¨ä¾‹ç”Ÿæˆå¤±è´¥: {str(e)}")

    def _clean_json(self, text: str) -> str:
        """æ¸…ç† JSON æ–‡æœ¬"""
        text = text.strip()
        if text.startswith("```"):
            lines = text.split("\n")
            lines = lines[1:-1] if lines[-1] == "```" else lines[1:]
            text = "\n".join(lines)
        if text.startswith("json"):
            text = text[4:]
        return text.strip()
